@using Piranha.Extend.Fields
@model CarAnimationBlock

<div class="car-animation">
  <div class="car-container">
    @if (Model.CarModel != null)
    {
      <div id="car-container" style="width: auto; height: 400px;"></div>
    }
  </div>
  <p>@Model.AltText</p>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r126/three.min.js"></script>
<script src="https://unpkg.com/three@0.126.0/examples/js/loaders/GLTFLoader.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Vytvoření scény Three.js
    var scene = new THREE.Scene();
    scene.background = null; // Odstranění pozadí scény

    var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    var renderer = new THREE.WebGLRenderer({ alpha: true }); // Zajištění transparentního pozadí

    // Získání velikosti divu "car-container"
    var carContainer = document.getElementById("car-container");
    var width = carContainer.clientWidth;
    var height = carContainer.clientHeight;

    // Nastavení velikosti rendereru podle velikosti divu "car-container"
    renderer.setSize(width, height);

    // Přidání rendereru do divu
    carContainer.appendChild(renderer.domElement);

    // Přidání více světel pro lepší osvětlení modelu
    var ambientLight = new THREE.AmbientLight(0x404040, 1);  // Měkké bílé světlo (slabé globální osvětlení)
    scene.add(ambientLight);

    var directionalLight = new THREE.DirectionalLight(0xffffff, 1); // Silné bílé světlo (směrové světlo)
    directionalLight.position.set(5, 5, 5).normalize(); // Nastavení pozice světla
    scene.add(directionalLight);

    var loader = new THREE.GLTFLoader();
    loader.load('/assets/glb/van.glb', function(gltf) {
      var carModel = gltf.scene;

      // Zvětšení modelu
      carModel.scale.set(3, 3, 3); // Zvětšení modelu (nastavení měřítka)
      carModel.position.set(0, 0, 0); // Ujistíme se, že model je na středu scény

      scene.add(carModel);

      // Nastavení kamery, aby byla zaměřena na model
      camera.position.set(0, 2, 5); // Zvýšení pozice kamery, aby byla výš nad autem
      camera.lookAt(carModel.position); // Kamera se podívá na model

      var animate = function() {
        requestAnimationFrame(animate);
        carModel.rotation.y += 0.002; // Pomalá rotace (zpomalení rotace)
        renderer.render(scene, camera);
      };
      animate();

      // Otáčení modelu po kliknutí tak, aby se podíval na zadní část (kufr)
      window.addEventListener('click', function() {
        // Zjistíme aktuální rotaci modelu
        var currentRotation = carModel.rotation.y;

        // Nastavení rotace na pozici, kde bude zadní část (kufr)
        var targetRotation = Math.PI * 2; // Zadní část auta je o 180° od původní pozice (nula)

        // Pokud je aktuální rotace blízko zadní části, zamezíme přetáčení (pro správnou logiku)
        if (Math.abs(currentRotation - targetRotation) > 0.01) {
          // Otočení modelu na zadní část auta
          var rotateInterval = setInterval(function() {
            if (Math.abs(carModel.rotation.y - targetRotation) > 0.01) {
              if (carModel.rotation.y < targetRotation) {
                carModel.rotation.y += 0.04; // Zpomalení otáčení modelu
              } else {
                carModel.rotation.y -= 0.04; // Zpomalení otáčení modelu v opačném směru
              }
            } else {
              clearInterval(rotateInterval);
              alert('Kufr se otevřel!');
            }
          }, 16);
        }
      });
    }, undefined, function(error) {
      console.error(error);
    });
  });
</script>
